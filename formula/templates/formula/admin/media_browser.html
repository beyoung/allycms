{% extends "admin/base_site.html" %}
{% load static %}
{% load media_filters %}

{% block title %}媒体浏览器{% endblock %}

{% block extrahead %}
<style>
    .media-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
        padding: 20px;
    }
    
    .media-item {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 10px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .media-item:hover {
        border-color: #007bff;
        box-shadow: 0 2px 8px rgba(0,123,255,0.3);
    }
    
    .media-item.selected {
        border-color: #28a745;
        background-color: #f8fff9;
    }
    
    .media-preview {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-radius: 4px;
        margin-bottom: 10px;
    }
    
    .media-title {
        font-size: 12px;
        color: #666;
        margin-bottom: 5px;
        word-break: break-word;
    }
    
    .media-info {
        font-size: 10px;
        color: #999;
    }
    
    .media-actions {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        border-top: 1px solid #ddd;
        padding: 15px;
        text-align: center;
        z-index: 1000;
    }
    
    .upload-area {
        border: 2px dashed #ddd;
        border-radius: 8px;
        padding: 40px;
        text-align: center;
        margin: 20px;
        transition: all 0.3s ease;
    }
    
    .upload-area:hover {
        border-color: #007bff;
        background-color: #f8f9fa;
    }
    
    .upload-area.dragover {
        border-color: #007bff;
        background-color: #e3f2fd;
    }
</style>
{% endblock %}

{% block content %}
<div class="media-browser">
    <div class="upload-area" id="uploadArea">
        <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #007bff; margin-bottom: 20px;"></i>
        <h3>拖拽文件到此处上传</h3>
        <p>或者 <input type="file" id="fileInput" multiple style="display: none;"> <a href="#" onclick="document.getElementById('fileInput').click(); return false;">点击选择文件</a></p>
    </div>
    
    <div class="media-grid" id="mediaGrid">
        {% for media in media_list %}
        <div class="media-item" data-media-id="{{ media.id }}" data-media-url="{{ media.file.url }}" data-media-title="{{ media.title }}">
            {% if media.file_type|is_image %}
                <img src="{{ media.file.url }}" alt="{{ media.title }}" class="media-preview">
            {% elif media.file_type|is_video %}
                <video class="media-preview" muted>
                    <source src="{{ media.file.url }}" type="video/mp4">
                </video>
            {% elif media.file_type|is_audio %}
                <div class="media-preview" style="background: #f8f9fa; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-music" style="font-size: 48px; color: #007bff;"></i>
                </div>
            {% else %}
                <div class="media-preview" style="background: #f8f9fa; display: flex; align-items: center; justify-content: center;">
                    <i class="{{ media.file_type|get_media_icon }}" style="font-size: 48px; color: #007bff;"></i>
                </div>
            {% endif %}
            <div class="media-title">{{ media.title }}</div>
            <div class="media-info">{{ media.file_type|upper }} • {{ media.file_size|filesizeformat }}</div>
        </div>
        {% endfor %}
    </div>
    
    <div class="media-actions">
        <button type="button" class="btn btn-primary" id="selectMedia" disabled>选择媒体</button>
        <button type="button" class="btn btn-secondary" onclick="window.close()">取消</button>
    </div>
</div>

<script>
let selectedMedia = null;

// 选择媒体
document.querySelectorAll('.media-item').forEach(item => {
    item.addEventListener('click', function() {
        // 移除之前的选中状态
        document.querySelectorAll('.media-item').forEach(i => i.classList.remove('selected'));
        
        // 添加选中状态
        this.classList.add('selected');
        
        // 保存选中的媒体信息
        selectedMedia = {
            id: this.dataset.mediaId,
            url: this.dataset.mediaUrl,
            title: this.dataset.mediaTitle
        };
        
        // 启用选择按钮
        document.getElementById('selectMedia').disabled = false;
    });
});

// 选择媒体按钮
document.getElementById('selectMedia').addEventListener('click', function() {
    if (selectedMedia) {
        // 发送消息给父窗口
        window.opener.postMessage({
            type: 'media_selected',
            media: selectedMedia
        }, '*');
        window.close();
    }
});

// 文件上传处理
const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');

// 拖拽上传
uploadArea.addEventListener('dragover', function(e) {
    e.preventDefault();
    this.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', function(e) {
    e.preventDefault();
    this.classList.remove('dragover');
});

uploadArea.addEventListener('drop', function(e) {
    e.preventDefault();
    this.classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    handleFiles(files);
});

// 文件选择
fileInput.addEventListener('change', function(e) {
    handleFiles(e.target.files);
});

function handleFiles(files) {
    Array.from(files).forEach(file => {
        uploadFile(file);
    });
}

function uploadFile(file) {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('title', file.name);
    
    fetch('/admin/formula/media/upload/', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 刷新页面显示新上传的文件
            location.reload();
        } else {
            alert('上传失败: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Upload error:', error);
        alert('上传失败，请重试');
    });
}
</script>
{% endblock %}
